# 飞书错题本生成试卷 v1.0

## 功能介绍

实现从飞书多维表格读取错题数据，自动生成 WORD 文档或 HTML 文档。支持生成题库和AI生成类似题目两种模式。

### 核心功能

#### 1. 题库生成功能
- ✅ 从飞书多维表格自动读取学科、知识点等数据
- ✅ 支持多学科、多知识点选择
- ✅ 支持为每个知识点自定义题目数量
- ✅ 自动从"去手写"字段读取内容，支持图片附件直接插入文档
- ✅ 随机抽题生成试卷
- ✅ 支持生成 WORD 文档和 HTML 文档两种格式
- ✅ 图片附件自动嵌入文档（base64编码），无需外部链接

#### 2. AI生成类似题目功能
- ✅ 基于智谱AI GLM-4.6V大模型生成类似题目
- ✅ 自动选择每个知识点最近创建的题目作为参考
- ✅ 支持多模态输入（图片+文本），可识别图片中的题目内容
- ✅ 支持生成 WORD 文档和 HTML 文档两种格式
- ✅ 可自定义每个知识点生成的题目数量
- ✅ 智能错误处理，生成失败的知识点不会出现在文档中

#### 3. 配置管理
- ✅ 飞书应用凭据自动保存，无需重复输入
- ✅ 智谱AI API Key配置，支持环境变量和本地配置
- ✅ 支持重新配置API Key（当API Key过期时）
- ✅ 自动使用智谱AI API Base URL，确保配置正确

## 使用说明

### 前置要求

1. Python 3.7 或更高版本
2. 安装依赖包：`pip install -r requirements.txt`
3. 飞书应用 App ID 和 App Secret（首次使用需要输入，会自动保存）
4. 智谱AI API Key（用于生成类似题目功能，可选）

### 快速开始

#### 方式一：批处理文件（推荐）

直接双击 `启动程序.bat` 即可启动。

#### 方式二：命令行

```bash
streamlit run app.py
```

#### 方式三：打包成 exe（可选）

运行 `一键打包.bat`，打包完成后在 `dist` 目录找到可执行文件。

### 使用步骤

#### 生成题库

1. **首次使用**：输入飞书应用的 App ID 和 App Secret（会自动保存到本地配置文件）

2. **选择学科**：从下拉列表中选择一个或多个学科

3. **选择知识点**：选择需要练习的知识点（可多选）

4. **设置题目数量**：为每个知识点设置要生成的题目数量

5. **生成题库**：
   - 点击"生成题库WORD文档"生成 Word 格式
   - 或点击"生成题库HTML"生成 HTML 格式

6. **下载**：点击下载按钮保存文档

#### 生成类似题目

1. **配置大模型**（首次使用）：
   - 在"大模型配置"区域输入智谱AI API Key
   - API Base URL 和模型名称会自动配置为智谱AI GLM-4.6V
   - 配置会自动保存，下次无需重新输入

2. **选择学科和知识点**：与生成题库相同

3. **设置题目数量**：为每个知识点设置要生成的类似题目数量

4. **生成类似题目**：
   - 点击"生成类似题目WORD文档"生成 Word 格式
   - 或点击"生成类似题目HTML"生成 HTML 格式
   - 系统会自动选择每个知识点最近创建的题目作为参考

5. **下载**：点击下载按钮保存文档

### 字段说明

程序会从飞书多维表格读取以下字段：

- **学科**：错题所属学科
- **知识点**：错题涉及的知识点（支持多选）
- **去手写**：题目内容（优先读取附件图片，如无附件则读取文本）
- **不会/做错**：错题类型
- **不会/做错原因**：详细的错误原因
- **创建时间**：用于选择最近创建的题目作为AI生成参考

## 配置说明

### 飞书多维表格配置

- `app_token`: `NO9nbcpjraKeUCsSQkBcHL9gnhh`（已默认配置）
- `table_id`: `tblchSd315sqHTCt`（已默认配置）

如需修改，可通过环境变量覆盖：
- `FEISHU_APP_TOKEN`: 多维表格的 app_token
- `FEISHU_TABLE_ID`: 多维表格的 table_id

### 飞书应用凭据

首次输入 App ID 和 App Secret 后，会自动保存到 `.feishu_config.json` 文件，下次启动无需重新输入。

**注意**：`.feishu_config.json` 包含敏感信息，请妥善保管，不要分享给他人。

### 智谱AI API配置

#### 方式一：程序内配置（推荐）

1. 在程序界面的"大模型配置"区域输入智谱AI API Key
2. API Base URL 会自动设置为 `https://open.bigmodel.cn/api/paas/v4`
3. 默认使用 `glm-4.6v` 模型（支持图片输入）
4. 配置会自动保存到 `.feishu_config.json`

#### 方式二：环境变量配置

设置以下环境变量：
- `LLM_API_KEY`: 智谱AI API Key
- `LLM_API_BASE`: `https://open.bigmodel.cn/api/paas/v4`（可选，程序会自动设置）
- `LLM_MODEL`: `glm-4.6v`（可选，程序会自动设置）

#### 方式三：重新配置API Key

如果API Key过期或无效：
1. 在"大模型配置"区域勾选"重新配置智谱AI API Key"
2. 输入新的API Key
3. 配置会自动保存

#### 获取智谱AI API Key

1. 访问 [智谱AI开放平台](https://open.bigmodel.cn/)
2. 注册/登录账号
3. 在控制台创建API Key
4. 确保API Key有权限使用 `glm-4.6v` 或 `glm-4` 模型

## 技术栈

- **前端框架**：Streamlit
- **文档生成**：python-docx（Word文档）
- **HTTP 请求**：requests
- **大模型**：智谱AI GLM-4.6V（支持多模态）
- **数据处理**：Python 标准库

## 文件结构

```
.
├── app.py              # 主程序文件
├── run_app.py          # 打包用的启动脚本
├── requirements.txt    # 依赖包列表
├── 启动程序.bat        # 快速启动脚本
├── 重启程序.bat        # 重启程序脚本
├── 一键打包.bat        # 打包脚本
├── build_exe.py        # 打包脚本（Python）
├── README.md           # 本文件
├── 打包说明.md         # 打包说明文档
└── .feishu_config.json # 凭据配置文件（自动生成）
```

## 功能特性

### 图片处理

- **支持的图片格式**：jpg, jpeg, png, gif, bmp, webp, svg
- **Word文档**：图片直接嵌入文档，无需外部链接
- **HTML文档**：图片以base64编码嵌入，可离线查看
- **AI生成**：支持识别图片中的题目内容，生成类似题目

### 错误处理

- **API认证失败**：清晰的错误提示，指导用户更新API Key
- **生成失败**：失败的知识点不会出现在文档中，只显示错误提示
- **网络错误**：自动重试和错误提示
- **图片下载失败**：显示友好的错误信息

### 用户体验

- **自动保存配置**：飞书和AI配置自动保存，无需重复输入
- **实时反馈**：生成过程中显示进度提示
- **格式选择**：支持Word和HTML两种格式，满足不同需求
- **多模态支持**：AI生成支持图片+文本输入，更智能

## 注意事项

1. **网络连接**：
   - 程序需要访问飞书 API，请确保网络畅通
   - AI生成功能需要访问智谱AI API

2. **权限配置**：
   - 飞书应用需要开通"多维表格"相关权限
   - 需要将应用（机器人）添加为多维表格的协作者

3. **API Key管理**：
   - 智谱AI API Key需要有效且有足够余额
   - 如果遇到401错误，请检查API Key是否正确或已过期
   - 可以通过"重新配置智谱AI API Key"功能更新

4. **题目数量限制**：
   - 每个知识点的题目数量不能超过该知识点下的题目总数
   - 系统会随机抽取指定数量的题目

5. **AI生成说明**：
   - AI生成基于每个知识点最近创建的题目
   - 如果参考题目包含图片，AI会识别图片内容
   - 生成失败的知识点不会出现在最终文档中

## 版本信息

**v1.0** - 2025-12-18

### 主要功能
- ✅ 实现从飞书多维表格读取错题数据
- ✅ 支持多学科、多知识点选择
- ✅ 支持图片附件直接插入文档
- ✅ 生成 WORD 和 HTML 两种格式的题库文档
- ✅ 集成智谱AI GLM-4.6V大模型生成类似题目
- ✅ 支持多模态输入（图片+文本）
- ✅ 智能错误处理和用户提示
- ✅ 配置自动保存和管理

### 技术特点
- 使用智谱AI GLM-4.6V模型，支持图片识别
- 图片自动嵌入文档，无需外部链接
- 完善的错误处理和用户提示
- 支持环境变量和本地配置文件

## 常见问题

### Q1: 遇到401错误怎么办？

**A:** 401错误表示API Key认证失败，请：
1. 检查智谱AI API Key是否正确
2. 确认API Key是否已过期
3. 使用"重新配置智谱AI API Key"功能更新API Key
4. 确认API Key有权限使用 `glm-4.6v` 模型

### Q2: 为什么生成的文档中某些知识点没有题目？

**A:** 可能原因：
1. 该知识点下没有符合条件的题目
2. AI生成失败（会显示错误提示）
3. 题目数量设置为0

### Q3: 图片无法显示怎么办？

**A:** 请检查：
1. 网络连接是否正常
2. 飞书应用是否有权限访问附件
3. 图片格式是否支持

### Q4: 如何更新API Key？

**A:** 有两种方式：
1. 在程序界面勾选"重新配置智谱AI API Key"，输入新Key
2. 直接编辑 `.feishu_config.json` 文件中的 `LLM_API_KEY` 字段

## 问题反馈

如遇问题，请检查：
1. Python 版本是否符合要求（3.7+）
2. 依赖包是否正确安装：`pip install -r requirements.txt`
3. 飞书应用权限是否正确配置
4. 网络连接是否正常
5. 智谱AI API Key是否有效且有余额

## 更新日志

### v1.0 (2025-12-18)
- 初始版本发布
- 实现题库生成功能（WORD和HTML格式）
- 集成智谱AI GLM-4.6V大模型
- 实现AI生成类似题目功能
- 支持多模态输入（图片+文本）
- 完善的错误处理和用户提示
- 配置自动保存功能
