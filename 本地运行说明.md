# 本地运行说明

## 🚀 快速启动

### 方法1：使用启动脚本（推荐）

1. **双击运行 `启动程序.bat`**
   - 脚本会自动启动 Streamlit 应用
   - 应用会在浏览器中自动打开

2. **如果浏览器没有自动打开**
   - 手动打开浏览器
   - 访问：`http://localhost:8501`

---

### 方法2：使用命令行

1. **打开命令提示符（CMD）**
   - 按 `Win + R`，输入 `cmd`，回车

2. **切换到项目目录**
   ```cmd
   cd /d "C:\Users\User\05MyAI\飞书错题本生成试卷"
   ```

3. **运行启动命令**
   ```cmd
   python -m streamlit run app.py
   ```

4. **访问应用**
   - 浏览器访问：`http://localhost:8501`

---

## 📋 本地运行时的行为

### 配置读取

本地运行时，应用会按以下优先级读取配置：

1. **环境变量**（如果设置了）
2. **本地配置文件**（`.feishu_config.json`）
3. **手动输入**（如果没有上述配置）

### 首次运行

如果本地没有配置文件，应用会：
- ✅ 显示输入框，让你输入 `FEISHU_APP_ID` 和 `FEISHU_APP_SECRET`
- ✅ 输入后会自动保存到 `.feishu_config.json`
- ✅ 下次启动时自动读取，无需再次输入

### 已有配置文件

如果 `.feishu_config.json` 已存在：
- ✅ 应用会自动读取配置
- ✅ 显示 "✓ 已检测到 FEISHU_APP_ID 和 FEISHU_APP_SECRET（来自本地配置文件）"
- ✅ 可以直接使用应用

---

## ⚙️ 本地配置方式

### 方式1：使用配置文件（推荐）

应用首次运行时会提示输入，输入后自动保存。

配置文件位置：`.feishu_config.json`

格式：
```json
{
  "FEISHU_APP_ID": "cli_a9c84f993638dceb",
  "FEISHU_APP_SECRET": "你的App_Secret",
  "LLM_API_KEY": "你的API_Key",
  "LLM_API_BASE": "https://open.bigmodel.cn/api/paas/v4",
  "LLM_MODEL": "glm-4.6v"
}
```

### 方式2：使用环境变量

在 Windows 上设置环境变量：

1. **临时设置（当前命令窗口）**
   ```cmd
   set FEISHU_APP_ID=cli_a9c84f993638dceb
   set FEISHU_APP_SECRET=你的App_Secret
   python -m streamlit run app.py
   ```

2. **永久设置（系统环境变量）**
   - 按 `Win + R`，输入 `sysdm.cpl`，回车
   - 点击 "高级" 标签页 → "环境变量"
   - 在 "用户变量" 中添加：
     - `FEISHU_APP_ID` = `cli_a9c84f993638dceb`
     - `FEISHU_APP_SECRET` = `你的App_Secret`
   - 点击 "确定" 保存
   - 重新打开命令提示符运行应用

### 方式3：使用 .streamlit/secrets.toml（高级）

1. **创建目录**
   ```cmd
   mkdir .streamlit
   ```

2. **创建 secrets.toml 文件**
   在 `.streamlit/secrets.toml` 中写入：
   ```toml
   [secrets]
   FEISHU_APP_ID = "cli_a9c84f993638dceb"
   FEISHU_APP_SECRET = "你的App_Secret"
   ```

3. **运行应用**
   ```cmd
   python -m streamlit run app.py
   ```

---

## 🔍 本地运行 vs Streamlit Cloud

| 特性 | 本地运行 | Streamlit Cloud |
|------|---------|----------------|
| 配置方式 | 配置文件/环境变量/手动输入 | Secrets |
| 显示输入框 | ✅ 是（如果没有配置） | ❌ 否（显示配置提示） |
| 配置文件位置 | `.feishu_config.json` | Settings → Secrets |
| 自动保存 | ✅ 是 | ❌ 否（通过 Secrets 配置） |

---

## ⚠️ 常见问题

### 问题1：找不到 Python

**错误信息：** `'python' 不是内部或外部命令`

**解决方法：**
- 确认已安装 Python
- 或将 `python` 替换为 `py` 或 `python3`

### 问题2：找不到 streamlit

**错误信息：** `No module named 'streamlit'`

**解决方法：**
```cmd
pip install -r requirements.txt
```

### 问题3：端口被占用

**错误信息：** `Port 8501 is already in use`

**解决方法：**
- 关闭占用 8501 端口的其他程序
- 或使用其他端口：
  ```cmd
  streamlit run app.py --server.port 8502
  ```

### 问题4：无法解析 open.feishu.cn（ConnectionError / getaddrinfo failed）

**错误信息：** `ConnectionError`、`NameResolutionError`、`Failed to resolve 'open.feishu.cn'`、`[Errno 11001] getaddrinfo failed`

**原因：** 本机 DNS 无法解析飞书域名，或网络/代理/VPN 限制访问。

**解决方法：**

1. **确认网络**：浏览器能打开 https://open.feishu.cn 再运行程序。
2. **检查 DNS**：在 CMD 执行：
   ```cmd
   nslookup open.feishu.cn
   ```
   若解析失败，可把网卡的 DNS 改为 `8.8.8.8` 或 `114.114.114.114`（控制面板 → 网络和 Internet → 更改适配器选项 → 右键网卡 → 属性 → IPv4 → 首选 DNS）。
3. **代理/VPN**：若开了代理或 VPN，先关闭或换节点后重试。
4. **公司/校园网**：可能屏蔽飞书，可换手机热点测试。

### 问题5：拉取记录失败 HTTP 400 / Invalid access token（99991663）

**错误信息：** `拉取记录失败 HTTP 400`、`Invalid access token for authorization`、错误码 `99991663`

**原因：** 应用已拿到飞书 tenant_access_token，但**没有被加入该多维表格的协作者**，或应用权限不足。

**若以前能正常用、近期没改过配置：** 多为飞书侧变动——例如多维表格的**协作者/分享被改**（应用被移出）、或飞书应用的**权限/发布状态**有更新。重新加一次协作者并检查开放平台即可。

**解决方法：**

1. **把应用添加为多维表格协作者**
   - 在飞书中打开该 **多维表格**（错题本所在的整个文档）
   - 点击右上角 **「…」→「分享」/「协作」**
   - 添加 **你的应用（机器人）** 为协作者，权限至少 **「可阅读」**

2. **检查开放平台权限**
   - 登录 [飞书开放平台](https://open.feishu.cn) → 你的应用 → **权限管理**
   - 开通 **多维表格**、**base:app** 等所需权限，并 **发布/启用** 新版本

3. **确认配置一致**
   - `FEISHU_APP_ID`、`FEISHU_APP_SECRET` 必须是该应用的凭证
   - 程序中的 `app_token` 必须对应 **已分享给该应用** 的多维表格

4. **官方文档**：[如何修复 99991663](https://open.feishu.cn/document/uAjLw4CM/ugTN1YjL4UTN24CO1UjN/trouble-shooting/how-to-fix-99991663-error)

---

## 💡 提示

1. **首次运行需要输入配置**
   - 这是正常的
   - 输入后会保存，下次不需要再输入

2. **本地运行可以测试功能**
   - 可以在本地测试所有功能
   - 确认无误后再推送到 Streamlit Cloud

3. **配置文件是敏感的**
   - `.feishu_config.json` 包含敏感信息
   - 已在 `.gitignore` 中，不会提交到 GitHub

---

## 🎯 快速开始

**最简单的启动方式：**

1. 双击 `启动程序.bat`
2. 如果提示输入配置，输入你的 `FEISHU_APP_ID` 和 `FEISHU_APP_SECRET`
3. 应用会自动启动并打开浏览器
4. 开始使用！
