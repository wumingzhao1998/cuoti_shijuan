# Secrets 配置已保存但仍显示错误的排查指南

## ❌ 问题现象

- ✅ Secrets 已经在 Streamlit Cloud 中配置并保存
- ❌ 应用页面仍然显示 "配置缺失" 的错误提示
- ❌ 应用无法读取到 Secrets

## 🔍 可能原因

### 原因1：应用没有重新部署（最常见）

**问题：** Secrets 保存后，应用需要重新部署才能读取到新的配置。

**解决方法：**
1. 进入 Settings → Secrets
2. 在 Secrets 末尾添加一个空行
3. 点击 **"Save changes"** 按钮
4. 等待应用自动重新部署（2-5 分钟）
5. 刷新应用页面

### 原因2：Secrets 格式有问题

**检查点：**
- ✅ 第一行必须是 `[secrets]`
- ✅ 使用英文双引号 `"`，不是中文引号
- ✅ 键名正确：`FEISHU_APP_ID` 和 `FEISHU_APP_SECRET`
- ✅ 值前后没有多余空格

**正确格式示例：**
```toml
[secrets]
FEISHU_APP_ID = "cli_a9c84f993638dceb"
FEISHU_APP_SECRET = "vEa2dJyfpd0D0fDwEsBW6eoPTn3nKj3i"
```

### 原因3：键名不匹配

**检查：**
- 键名必须完全匹配（区分大小写）
- `FEISHU_APP_ID` 不是 `FEISHU_APPID`
- `FEISHU_APP_SECRET` 不是 `FEISHU_APP_SECRETS`

### 原因4：代码还没有更新

**检查：**
- 确认代码已经推送到 GitHub
- 确认 Streamlit Cloud 使用的是正确的分支
- 等待 Streamlit Cloud 重新部署完成

---

## ✅ 解决步骤（按顺序执行）

### 步骤1：确认 Secrets 配置正确

1. 进入 Settings → Secrets
2. 检查配置格式是否正确
3. 确认所有键名和值都正确
4. 如果有问题，修正后点击 Save

### 步骤2：触发应用重新部署

**方法A：修改 Secrets（推荐）**
1. 在 Secrets 末尾添加一个空行
2. 点击 **"Save changes"**
3. 等待自动重新部署

**方法B：推送代码更新**
- 如果有代码更新，推送后会触发自动部署

### 步骤3：等待部署完成

- 通常需要 2-5 分钟
- 查看应用状态：🟡 黄色 = 部署中，🟢 绿色 = 完成

### 步骤4：刷新应用页面

1. 访问应用 URL
2. 刷新页面（F5 或 Ctrl+R）
3. 检查是否还显示错误

---

## 🔧 如果还是不行

### 检查清单

- [ ] Secrets 格式是否正确？
- [ ] 是否点击了 "Save changes"？
- [ ] 应用是否已重新部署（查看状态图标）？
- [ ] 是否等待足够的时间（至少 5 分钟）？
- [ ] 是否刷新了应用页面？
- [ ] 代码是否已更新到最新版本？

### 进一步排查

1. **查看部署日志**
   - Manage app → Logs
   - 查看是否有错误信息

2. **检查 Secrets 是否真的保存了**
   - 刷新 Settings → Secrets 页面
   - 确认配置还在

3. **尝试清除浏览器缓存**
   - 按 Ctrl+Shift+R 强制刷新
   - 或者清除浏览器缓存后重新访问

---

## 💡 重要提示

1. **Secrets 保存后会触发重新部署**
   - 这是正常的
   - 需要等待部署完成

2. **部署需要时间**
   - 通常 2-5 分钟
   - 请耐心等待

3. **代码已修复**
   - 最新的代码已经简化了 Secrets 读取逻辑
   - 使用标准的 `st.secrets.get()` 方法
   - 应该能正确读取 Secrets

---

## 🎯 推荐操作流程

1. **确认 Secrets 已正确配置并保存** ✅
2. **触发重新部署**：在 Secrets 末尾添加空行 → Save
3. **等待 3-5 分钟**
4. **刷新应用页面**
5. **检查是否已修复**

如果按照以上步骤操作后仍然有问题，可能需要进一步检查代码或联系支持。
